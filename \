/**
 * author:  hyerim k
 *   note:  external sensor modules
 *          of sleep monitoring service 'croissant'
 */

const gpio = require('wiring-pi')
const request = require('../lib/request')

let sleepMode = false
let securityMode = false

const fire = {
  //member variables
  PIN: 23,

  //function
  init(){
    gpio.pinMode( this.PIN, gpio.INPUT )
  },
  read() {
    const data = gpio.digitalRead( this.PIN )
    if( !data ){
      buzzer_act.write()
    }
    return data
  }
}

const buzzer_act = {
  //member variables
  PIN: 1,
  time: 1500,

  //function
  init() {
    gpio.pinMode( this.PIN, gpio.OUTPUT )
  },
  write() {
    gpio.digitalWrite( this.PIN, 1 )
    gpio.delay( this.time )
    gpio.digitalWrite( this.PIN, 0 )
  },

}

const buzzer_pas = {
  //member variables
  PIN: 5,
  time: 200,

  //function
  init() {
    gpio.pinMode( this.PIN, gpio.OUTPUT )
  },
  write() {
    gpio.digitalWrite( this.PIN, 1 )
    gpio.delay( this.time )
    gpio.digitalWrite( this.PIN, 0 )
  },
}

const button = {
  //member variables
  PIN: 4,

  //function
  init() {

	  gpio.pinMode( this.PIN, gpio.INPUT )
    console.log("button initated")
  },
  readStart() {
    setInterval( () => {
      const data = gpio.digitalRead( this.PIN )
      if( !data ){
        sleepMode = sleepMode ? false : true
	console.log(sleepMode)
	securityMode = sleepMode
	request('post', `/sleep/${sleepMode ? 'on' : 'off'}`)

        console.log("button pushed!")
      }
      else {

      }
    }, 100)
  }

}

const led = {
  //member variables
  RED: 23,
  GREEN: 24,
  BLUE: 25,

  //function
  init() {
    gpio.pinMode( this.RED, gpio.OUTPUT )
    gpio.pinMode( this.GREEN, gpio.OUTPUT )
    gpio.pinMode( this.BLUE, gpio.OUTPUT )
    console.log("led initiated")
  },
  quit() {
    gpio.digitalWrite(this.RED, 0)
    gpio.digitalWrite(this.GREEN, 0)
    gpio.digitalWrite(this.BLUE, 0)
  },
  off() {
    gpio.digitalWrite(this.RED, 1)
    gpio.digitalWrite(this.GREEN, 0)
    gpio.digitalWrite(this.BLUE, 0)
  },
  on() {
    gpio.digitalWrite(this.RED, 0)
    gpio.digitalWrite(this.GREEN, 1)
    gpio.digitalWrite(this.BLUE, 0)
  },
}


module.exports = {
  setModeStatus(sleep, security) {
    sleepMode = sleep
    securityMode = security
  },

  init() {
    gpio.wiringPiSetup()
  console.log(`sleepMode = ${sleepMode}`)
    fire.init()
    buzzer_pas.init()
    buzzer_act.init()
    button.init()
    led.init()

    button.readStart()
    setInterval( () => {
      if( sleepMode && securityMode ) {
        fire.read()
      }
    }, 500)
  },
}


gpio.wiringPiSetup()
button.init()
led.init()

button.readStart()
